<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Realtime</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    /* Reset & Base Styles */
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: url('https://raw.githubusercontent.com/ikyYourStar/ZedxChat/refs/heads/main/assets/Tak%20berjudul134_20250707192207.png') no-repeat center center fixed;
      background-size: cover;
    }
    body { display: flex; flex-direction: column; }

    /* Login Page */
    #login-page {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://raw.githubusercontent.com/ikyYourStar/ZedxChat/refs/heads/main/assets/ced57229-34ea-461b-9ecd-7a1b17154cd3.jpeg') no-repeat center center fixed;
      background-size: cover; display: flex; justify-content: center; align-items: center;
      flex-direction: column; z-index: 1000; color: white; text-shadow: 1px 1px 2px black;
    }
    #login-form {
      background: rgba(0, 0, 0, 0.7); padding: 5vw; border-radius: 2vw; text-align: center;
      width: 80%; max-width: 400px;
    }
    #login-form h2 { margin-bottom: 4vw; font-size: 6vw; }
    #login-form input {
      width: calc(100% - 4vw); padding: 3vw; margin-bottom: 3vw; border-radius: 1vw;
      border: none; font-size: 4vw;
    }
    #login-form button {
      width: 100%; padding: 3vw; background: #4caf50; color: white; border: none;
      border-radius: 1vw; font-size: 4.5vw; cursor: pointer; margin-top: 2vw;
    }
    #login-form #toggle-mode {
      background: none; color: #add8e6; border: none; font-size: 3.5vw;
      cursor: pointer; margin-top: 3vw; padding: 0; text-decoration: underline;
    }
    #login-error { color: #ffdddd; margin-top: 2vw; font-size: 3.5vw; display: none; }

    /* Chat Wrapper (Main Layout) */
    #chat-wrapper {
      flex: 1; display: flex; flex-direction: column; display: none;
      padding-top: 0; padding-bottom: 0; overflow: hidden;
      position: relative; /* Penting untuk z-index sidebar */
    }

    /* Sidebar/Overlay Menu */
    #sidebar {
      position: fixed; top: 0; left: -80vw; /* Dimulai di luar layar */
      width: 80vw; height: 100%; background: #2c3e50; /* Warna gelap */
      z-index: 1000; transition: left 0.3s ease; /* Animasi geser */
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
      padding: 5vw 3vw; color: white;
      display: flex; flex-direction: column;
    }
    #sidebar.active {
      left: 0; /* Geser ke dalam layar */
    }
    #sidebar-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 5vw; padding-bottom: 3vw; border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    #sidebar-header h3 {
        margin: 0; font-size: 6vw;
    }
    #close-sidebar {
        background: none; border: none; color: white; font-size: 8vw; cursor: pointer;
    }
    #add-friend-section {
        margin-bottom: 5vw; padding-bottom: 3vw; border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    #add-friend-section h4 { margin: 0 0 3vw 0; font-size: 4.5vw; }
    #add-friend-input {
        width: calc(100% - 2vw); padding: 2.5vw; margin-right: 1vw; border-radius: 1vw;
        border: none; font-size: 4vw;
    }
    #add-friend-btn {
        padding: 2.5vw 4vw; background: #3498db; color: white; border: none;
        border-radius: 1vw; font-size: 4vw; cursor: pointer;
    }
    #add-friend-message { color: #e74c3c; margin-top: 2vw; font-size: 3.5vw; }

    /* New: Friend Requests Section */
    #friend-requests-section {
        margin-bottom: 5vw; padding-bottom: 3vw; border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    #friend-requests-section h4 { margin: 0 0 3vw 0; font-size: 4.5vw; }
    #friend-requests-list {
        /* overflow-y: auto; */ /* Enable scroll if many requests */
    }
    .friend-request-item {
        display: flex; flex-direction: column; padding: 3vw; margin-bottom: 2vw;
        background: rgba(255,255,255,0.1); border-radius: 1vw;
    }
    .friend-request-item .request-info {
        font-size: 4.5vw; font-weight: bold; margin-bottom: 2vw;
    }
    .friend-request-item .request-actions {
        display: flex; gap: 2vw;
    }
    .friend-request-item .request-actions button {
        flex: 1; padding: 2vw 3vw; border-radius: 1vw; border: none;
        font-size: 3.8vw; cursor: pointer;
    }
    .friend-request-item .request-actions .accept-btn {
        background: #27ae60; color: white;
    }
    .friend-request-item .request-actions .decline-btn {
        background: #e74c3c; color: white;
    }


    #friend-list-section h4 { margin: 0 0 3vw 0; font-size: 4.5vw; }
    #friend-list {
        flex-grow: 1;
        overflow-y: auto;
    }
    .friend-item {
        display: flex; align-items: center; padding: 3vw; margin-bottom: 2vw;
        background: rgba(255,255,255,0.1); border-radius: 1vw; cursor: pointer;
        transition: background 0.2s ease;
    }
    .friend-item:hover { background: rgba(255,255,255,0.2); }
    .friend-item .friend-avatar {
        width: 10vw; height: 10vw; border-radius: 50%; background: #ddd;
        margin-right: 3vw; display: flex; justify-content: center; align-items: center;
        font-size: 5vw; font-weight: bold; color: #333;
    }
    .friend-item .friend-name {
        font-size: 4.5vw; font-weight: bold;
    }

    /* Overlay untuk menutup sidebar saat di klik di luar */
    #sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 999; display: none;
    }

    /* Chat Header */
    #chat-header {
      background: #f0f2f5; padding: 3vw; display: flex; justify-content: space-between;
      align-items: center; border-bottom: 1px solid #ccc; font-size: 5vw; font-weight: bold;
      position: fixed; top: 0; left: 0; width: 100%; z-index: 990;
    }
    #chat-header h3 { margin: 0; font-size: 5vw; text-align: center; flex-grow: 1; }
    #header-username {
      flex-grow: 1; text-align: center;
    }
    #menu-button, #back-to-public-chat, #options-button {
      background: none; border: none; font-size: 6vw; cursor: pointer; padding: 0;
    }
    #menu-button { margin-right: 2vw; }
    #options-button { margin-left: 2vw; }


    #logout-menu {
      position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd;
      border-radius: 1vw; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none;
      flex-direction: column; min-width: 25vw; z-index: 1001;
    }
    #logout-menu button {
      background: none; border: none; padding: 3vw; text-align: left; font-size: 4vw;
      width: 100%; cursor: pointer; color: #333;
    }
    #logout-menu button:hover { background: #f0f0f0; }

    /* Chat Container (Scrollable Area) */
    #chat-container {
      flex: 1; overflow-y: auto; padding: 3vw;
    }

    /* Message Styles */
    .msg {
      max-width: 75%; padding: 3vw; margin: 2vw 0; border-radius: 2vw; word-wrap: break-word;
      font-size: 4vw; position: relative; transition: transform 0.2s ease; will-change: transform;
    }
    .own { background: #dcf8c6; margin-left: auto; text-align: left; }
    .own * { text-align: left !important; }
    .other { background: #e5e5ea; margin-right: auto; text-align: left; }
    .reply { font-size: 3.2vw; opacity: 0.6; margin-bottom: 1vw; }
    .msg img { max-width: 100%; border-radius: 1vw; margin-top: 1vw; }
    .time { font-size: 3vw; opacity: 0.5; display: block; margin-top: 1vw; }
    .own .time { text-align: left; }
    .other .time { text-align: left; }

    /* Reply & Input Area (Fixed) */
    #reply-preview {
      background: rgba(0,0,0,0.6); color: white; padding: 2vw; font-size: 3.5vw;
      display: none; justify-content: space-between; align-items: center;
      position: fixed; bottom: var(--input-area-height, 15vw); left: 0; width: 100%; z-index: 998;
    }
    #reply-preview span { flex: 1; }

    #input-area {
      display: flex; gap: 2vw; padding: 2vw; background: #fff; border-top: 1px solid #ccc;
      align-items: center; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 999;
    }
    #input {
      flex: 1; padding: 2.5vw; font-size: 4vw; border: 1px solid #ccc; border-radius: 1vw;
    }
    #send {
      padding: 2.5vw 4vw; background: #4caf50; color: white; border: none;
      border-radius: 1vw; font-size: 4vw; cursor: pointer;
    }
    #uploadBtn { background: none; border: none; font-size: 6vw; cursor: pointer; }


    /* Media Queries for Desktop */
    @media (min-width: 768px) {
      #sidebar { left: -300px; width: 300px; padding: 20px 15px; }
      #sidebar.active { left: 0; }
      #sidebar-header h3 { font-size: 24px; }
      #close-sidebar { font-size: 32px; }
      #add-friend-section h4, #friend-list-section h4, #friend-requests-section h4 { font-size: 18px; }
      #add-friend-input { padding: 10px; font-size: 16px; width: calc(100% - 10px); }
      #add-friend-btn { padding: 10px 15px; font-size: 16px; }
      #add-friend-message { font-size: 14px; }

      .friend-request-item { padding: 12px; margin-bottom: 8px; }
      .friend-request-item .request-info { font-size: 18px; margin-bottom: 8px; }
      .friend-request-item .request-actions { gap: 8px; }
      .friend-request-item .request-actions button { padding: 8px 12px; font-size: 15px; }

      .friend-item { padding: 12px; margin-bottom: 8px; }
      .friend-item .friend-avatar { width: 40px; height: 40px; font-size: 20px; margin-right: 15px; }
      .friend-item .friend-name { font-size: 18px; }


      #chat-header {
        padding: 15px; font-size: 20px;
      }
      #chat-header h3 { font-size: 20px; }
      #menu-button, #back-to-public-chat, #options-button { font-size: 24px; }
      #menu-button { margin-right: 10px; }
      #options-button { margin-left: 10px; }


      #logout-menu { border-radius: 4px; min-width: 100px; }
      #logout-menu button { padding: 12px; font-size: 16px; }
      #input-area { padding: 10px; }
      #reply-preview { bottom: var(--input-area-height, 60px); padding: 10px; font-size: 14px; }

      .msg { font-size: 16px; }
      .reply { font-size: 13px; }
      #input { font-size: 16px; }
      #send { font-size: 16px; }
      #uploadBtn { font-size: 24px; }
      .time { font-size: 12px; }

      #login-form h2 { font-size: 24px; }
      #login-form input { font-size: 16px; padding: 12px; margin-bottom: 12px; width: calc(100% - 24px); }
      #login-form button { font-size: 18px; padding: 12px; margin-top: 8px; }
      #login-form #toggle-mode { font-size: 14px; margin-top: 12px; }
      #login-error { font-size: 14px; margin-top: 8px; }
      #login-form { padding: 20px; border-radius: 8px; }
    }
  </style>
</head>
<body>

  <div id="login-page">
    <div id="login-form">
      <h2 id="form-title">Login</h2>
      <input type="text" id="username-input" placeholder="Username" required />
      <input type="password" id="password-input" placeholder="Password" required />
      <button id="auth-button">Login</button>
      <p id="login-error"></p>
      <button id="toggle-mode">Belum punya akun? Daftar di sini.</button>
    </div>
  </div>

  <div id="chat-wrapper">

    <div id="sidebar">
        <div id="sidebar-header">
            <h3>Menu</h3>
            <button id="close-sidebar">√ó</button>
        </div>

        <div id="add-friend-section">
            <h4>Tambah Teman</h4>
            <input type="text" id="add-friend-input" placeholder="Username teman" />
            <button id="add-friend-btn">Tambah</button>
            <p id="add-friend-message"></p>
        </div>

        <div id="friend-requests-section">
            <h4>Permintaan Pertemanan</h4>
            <div id="friend-requests-list">
                <p id="no-friend-requests" style="font-size: 3.5vw; opacity: 0.8;">Tidak ada permintaan baru.</p>
            </div>
        </div>

        <div id="friend-list-section">
            <h4>Daftar Teman</h4>
            <div id="friend-list">
                </div>
        </div>
    </div>
    <div id="sidebar-overlay"></div>

    <div id="chat-header">
      <button id="sidebar-toggle-button">‚ò∞</button>
      <button id="back-to-public-chat" style="display:none;">‚Üê</button>
      <h3 id="chat-title">Chat Publik</h3>
      <button id="options-button">‚ãÆ</button>
      <div id="logout-menu">
        <button id="logout-button">Logout</button>
      </div>
    </div>

    <div id="chat-container"></div>

    <div id="reply-preview">
      <span id="reply-text"></span>
      <button onclick="cancelReply()" style="background:none;border:none;color:white;font-size:5vw;">√ó</button>
    </div>

    <div id="input-area">
      <button id="uploadBtn">üìé</button>
      <input type="file" id="fileInput" accept="image/*" style="display:none;" />
      <input type="text" id="input" placeholder="Ketik pesan..." />
      <button id="send">Kirim</button>
    </div>
  </div>

  <script>
    // Firebase Config (your actual config)
    const firebaseConfig = {
      apiKey: "AIzaSyCTjBsKdHmmTELY3wnfGYANEzzDBEF2BIo",
      authDomain: "realtime-df5d0.firebaseapp.com",
      databaseURL: "https://realtime-df5d0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "realtime-df5d0",
      storageBucket: "realtime-df5d0.appspot.com",
      messagingSenderId: "1065067984786",
      appId: "1:1065067984786:web:b315a080932587ec53f34b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const imgbbKey = "a12e3657b8edd041c13eda8c12ff5925";

    // --- UI Elements ---
    // Login
    const loginPage = document.getElementById("login-page");
    const usernameInput = document.getElementById("username-input");
    const passwordInput = document.getElementById("password-input");
    const authButton = document.getElementById("auth-button");
    const toggleModeButton = document.getElementById("toggle-mode");
    const formTitle = document.getElementById("form-title");
    const loginError = document.getElementById("login-error");
    const chatWrapper = document.getElementById("chat-wrapper");

    // Chat
    const chatHeader = document.getElementById('chat-header');
    const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
    const backToPublicChatButton = document.getElementById('back-to-public-chat');
    const chatTitle = document.getElementById('chat-title');
    const optionsButton = document.getElementById("options-button");
    const logoutMenu = document.getElementById("logout-menu");
    const logoutButton = document.getElementById("logout-button");
    const chatContainer = document.getElementById("chat-container");
    const inputArea = document.getElementById('input-area');
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const replyPreview = document.getElementById("reply-preview");
    const replyText = document.getElementById("reply-text");

    // Sidebar
    const sidebar = document.getElementById('sidebar');
    const closeSidebarButton = document.getElementById('close-sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const addFriendInput = document.getElementById('add-friend-input');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const addFriendMessage = document.getElementById('add-friend-message');
    const friendList = document.getElementById('friend-list');
    const friendRequestsList = document.getElementById('friend-requests-list'); // NEW
    const noFriendRequests = document.getElementById('no-friend-requests'); // NEW

    // --- Global State Variables ---
    let isLoginMode = true;
    let currentUsername = null;
    let currentUid = null;
    let replyTo = null;

    let currentChatMode = 'public'; // 'public' or 'private'
    let currentPrivateChatFriendUid = null;
    let currentPrivateChatFriendUsername = null;

    // --- Helper Functions ---
    function usernameToEmail(username) {
        return `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@chatkita.com`;
    }

    function getPrivateChatId(uid1, uid2) {
        // Always sort UIDs to get a consistent chat ID
        return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    }

    function cancelReply() {
      replyTo = null;
      replyPreview.style.display = "none";
    }

    function adjustChatWrapperPadding() {
        const headerHeight = chatHeader.offsetHeight;
        const inputAreaHeight = inputArea.offsetHeight;
        chatWrapper.style.paddingTop = `${headerHeight}px`;
        chatWrapper.style.paddingBottom = `${inputAreaHeight}px`;
        replyPreview.style.setProperty('--input-area-height', `${inputAreaHeight}px`);
    }

    // --- Authentication Logic ---
    toggleModeButton.addEventListener("click", () => {
      isLoginMode = !isLoginMode;
      if (isLoginMode) {
        formTitle.textContent = "Login";
        authButton.textContent = "Login";
        toggleModeButton.textContent = "Belum punya akun? Daftar di sini.";
      } else {
        formTitle.textContent = "Daftar";
        authButton.textContent = "Daftar";
        toggleModeButton.textContent = "Sudah punya akun? Login di sini.";
      }
      loginError.style.display = "none";
    });

    authButton.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      const emailForAuth = usernameToEmail(username);
      loginError.style.display = "none";

      if (!username || !password) {
        loginError.textContent = "Username dan password harus diisi.";
        loginError.style.display = "block";
        return;
      }

      try {
        if (isLoginMode) {
          await auth.signInWithEmailAndPassword(emailForAuth, password);
        } else {
          const userCredential = await auth.createUserWithEmailAndPassword(emailForAuth, password);
          await db.ref('users/' + userCredential.user.uid).set({
            username: username,
            emailForAuth: emailForAuth
          });
          alert("Pendaftaran berhasil! Silakan login.");
          isLoginMode = true;
          formTitle.textContent = "Login";
          authButton.textContent = "Login";
          toggleModeButton.textContent = "Belum punya akun? Daftar di sini.";
        }
      } catch (error) {
        let errorMessage = "Terjadi kesalahan. Silakan coba lagi.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "Username tidak ditemukan.";
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = "Password salah.";
        } else if (error.code === 'auth/email-already-in-use') {
          errorMessage = "Username sudah digunakan.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "Format username tidak valid. Gunakan hanya huruf dan angka.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "Password harus minimal 6 karakter.";
        }
        loginError.textContent = errorMessage;
        loginError.style.display = "block";
        console.error("Authentication error:", error);
      }
    });

    // --- Message Rendering ---
    function renderMessage(key, data) { // Removed isPrivate parameter, now logic is based on currentChatMode
      const div = document.createElement("div");
      const isOwn = data.userUid === currentUid;
      div.classList.add("msg", isOwn ? "own" : "other");
      div.id = "msg-" + key;

      const time = new Date(data.timestamp || Date.now());
      const timeStr = time.getHours().toString().padStart(2, "0") + ":" +
                       time.getMinutes().toString().padStart(2, "0");

      if (data.deleted) {
        div.textContent = "Pesan ini telah dihapus";
        div.style.fontStyle = "italic";
        chatContainer.appendChild(div);
        return;
      }

      if (data.reply) {
        const replyDiv = document.createElement("div");
        replyDiv.className = "reply";
        replyDiv.textContent = data.reply.user + ": " + data.reply.message;
        div.appendChild(replyDiv);
      }

      const contentDiv = document.createElement("div");

      if (data.imageURL) {
        if (!isOwn) {
          const label = document.createElement("strong");
          label.textContent = data.user;
          contentDiv.appendChild(label);
          contentDiv.appendChild(document.createElement("br"));
        }
        const img = document.createElement("img");
        img.src = data.imageURL;
        img.alt = "gambar";
        contentDiv.appendChild(img);
      } else {
        const text = isOwn ? data.message : `${data.user}: ${data.message}`;
        const p = document.createElement("div");
        p.textContent = text;
        contentDiv.appendChild(p);
      }

      const timeEl = document.createElement("span");
      timeEl.className = "time";
      timeEl.textContent = timeStr;
      contentDiv.appendChild(document.createElement("br"));
      contentDiv.appendChild(timeEl);

      div.appendChild(contentDiv);
      chatContainer.appendChild(div);

      let startX = 0, startY = 0, moved = false;
      div.addEventListener("touchstart", e => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      });
      div.addEventListener("touchmove", e => {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dy) > Math.abs(dx)) return;
        if (dx > 0 && dx < 100) {
          moved = true;
          div.style.transform = `translateX(${dx}px)`;
        }
      });
      div.addEventListener("touchend", e => {
        const dx = e.changedTouches[0].clientX - startX;
        if (moved && dx > 60) {
          replyTo = { user: data.user, message: data.message || 'Gambar' };
          replyText.textContent = "Balas: " + replyTo.user + ": " + replyTo.message;
          replyPreview.style.display = "flex";
        }
        div.style.transform = "translateX(0)";
        moved = false;
      });

      if (isOwn) {
        let timeout = null;
        div.addEventListener("touchstart", () => {
          timeout = setTimeout(() => {
            if (confirm("Hapus pesan ini?")) {
              const chatRef = (currentChatMode === 'public')
                ? db.ref(`chats/${key}`)
                : db.ref(`private_chats/${getPrivateChatId(currentUid, currentPrivateChatFriendUid)}/messages/${key}`);
              chatRef.update({ deleted: true });
            }
          }, 600);
        });
        div.addEventListener("touchend", () => clearTimeout(timeout));
      }
    }

    // --- Chat Mode Management ---
    let chatListenerRef = null;

    function loadPublicChat() {
        if (chatListenerRef) {
            chatListenerRef.off();
        }
        currentChatMode = 'public';
        currentPrivateChatFriendUid = null;
        currentPrivateChatFriendUsername = null;
        chatTitle.textContent = "Chat Publik";
        backToPublicChatButton.style.display = 'none';
        chatContainer.innerHTML = '';

        chatListenerRef = db.ref("chats");
        chatListenerRef.on("value", (snapshot) => {
            chatContainer.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                renderMessage(childSnapshot.key, childSnapshot.val());
            });
            scrollToBottom();
        });
    }

    function loadPrivateChat(friendUid, friendUsername) {
        if (chatListenerRef) {
            chatListenerRef.off();
        }
        currentChatMode = 'private';
        currentPrivateChatFriendUid = friendUid;
        currentPrivateChatFriendUsername = friendUsername;
        chatTitle.textContent = friendUsername;
        backToPublicChatButton.style.display = 'block';
        chatContainer.innerHTML = '';
        closeSidebar();

        const privateChatId = getPrivateChatId(currentUid, friendUid);
        chatListenerRef = db.ref(`private_chats/${privateChatId}/messages`);
        chatListenerRef.on("value", (snapshot) => {
            chatContainer.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                renderMessage(childSnapshot.key, childSnapshot.val());
            });
            scrollToBottom();
        });
    }

    // --- Sidebar Functions ---
    function openSidebar() {
        sidebar.classList.add('active');
        sidebarOverlay.style.display = 'block';
    }

    function closeSidebar() {
        sidebar.classList.remove('active');
        sidebarOverlay.style.display = 'none';
        logoutMenu.style.display = 'none';
    }

    sidebarToggleButton.addEventListener('click', openSidebar);
    closeSidebarButton.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);

    // --- Add Friend Logic ---
    addFriendBtn.addEventListener('click', async () => {
        const friendUsername = addFriendInput.value.trim();
        addFriendMessage.textContent = '';

        if (!friendUsername) {
            addFriendMessage.textContent = 'Masukkan username teman.';
            return;
        }
        if (friendUsername === currentUsername) {
            addFriendMessage.textContent = 'Tidak bisa menambahkan diri sendiri.';
            return;
        }

        try {
            const allUsersSnapshot = await db.ref('users').once('value');
            let friendUid = null;
            let foundFriendUsername = null;

            allUsersSnapshot.forEach(userNode => {
                if (userNode.val().username === friendUsername) {
                    friendUid = userNode.key;
                    foundFriendUsername = userNode.val().username;
                    return true;
                }
            });

            if (friendUid && friendUid !== currentUid) {
                // Check if already friends
                const alreadyFriends = (await db.ref(`users/${currentUid}/friends/${friendUid}`).once('value')).exists();
                if (alreadyFriends) {
                    addFriendMessage.textContent = `${foundFriendUsername} sudah ada di daftar teman Anda.`;
                    return;
                }

                // Check if a request is already sent
                const requestAlreadySent = (await db.ref(`users/${currentUid}/friend_requests_sent/${friendUid}`).once('value')).exists();
                if (requestAlreadySent) {
                    addFriendMessage.textContent = `Permintaan sudah terkirim ke ${foundFriendUsername}.`;
                    return;
                }

                // Check if there's a pending request from the other user
                const requestFromFriendExists = (await db.ref(`users/${currentUid}/friend_requests_received/${friendUid}`).once('value')).exists();
                if (requestFromFriendExists) {
                    addFriendMessage.textContent = `Anda sudah menerima permintaan dari ${foundFriendUsername}. Silakan terima di bagian Permintaan Pertemanan.`;
                    return;
                }


                // Send friend request to the target user
                await db.ref(`users/${friendUid}/friend_requests_received/${currentUid}`).set({
                    username: currentUsername,
                    uid: currentUid,
                    timestamp: Date.now()
                });

                // Record that this user sent a request
                await db.ref(`users/${currentUid}/friend_requests_sent/${friendUid}`).set({
                    username: foundFriendUsername,
                    uid: friendUid,
                    timestamp: Date.now()
                });

                addFriendInput.value = '';
                addFriendMessage.textContent = `Permintaan pertemanan terkirim ke ${foundFriendUsername}.`;
                // No need to loadFriendList here as they are not yet friends
            } else {
                addFriendMessage.textContent = 'Username tidak ditemukan atau Anda mencoba menambahkan diri sendiri.';
            }
        } catch (error) {
            console.error("Error adding friend:", error);
            addFriendMessage.textContent = 'Gagal menambahkan teman. Coba lagi.';
        }
    });

    // --- Load Friend Requests ---
    function loadFriendRequests() {
        if (!currentUid) return;

        friendRequestsList.innerHTML = ''; // Clear previous requests
        db.ref(`users/${currentUid}/friend_requests_received`).on('value', (snapshot) => {
            friendRequestsList.innerHTML = '';
            if (!snapshot.exists()) {
                noFriendRequests.style.display = 'block';
                return;
            } else {
                noFriendRequests.style.display = 'none';
            }

            snapshot.forEach((requestNode) => {
                const requestData = requestNode.val();
                const senderUid = requestNode.key;

                const requestItem = document.createElement('div');
                requestItem.classList.add('friend-request-item');

                const info = document.createElement('div');
                info.classList.add('request-info');
                info.textContent = `${requestData.username} ingin berteman dengan Anda.`;
                requestItem.appendChild(info);

                const actions = document.createElement('div');
                actions.classList.add('request-actions');

                const acceptBtn = document.createElement('button');
                acceptBtn.classList.add('accept-btn');
                acceptBtn.textContent = 'Terima';
                acceptBtn.addEventListener('click', () => acceptFriendRequest(senderUid, requestData.username));
                actions.appendChild(acceptBtn);

                const declineBtn = document.createElement('button');
                declineBtn.classList.add('decline-btn');
                declineBtn.textContent = 'Tolak';
                declineBtn.addEventListener('click', () => declineFriendRequest(senderUid));
                actions.appendChild(declineBtn);

                requestItem.appendChild(actions);
                friendRequestsList.appendChild(requestItem);
            });
        });
    }

    async function acceptFriendRequest(senderUid, senderUsername) {
        try {
            // Add sender to current user's friend list
            await db.ref(`users/${currentUid}/friends/${senderUid}`).set({
                username: senderUsername,
                uid: senderUid
            });

            // Add current user to sender's friend list
            await db.ref(`users/${senderUid}/friends/${currentUid}`).set({
                username: currentUsername,
                uid: currentUid
            });

            // Remove request from current user's received requests
            await db.ref(`users/${currentUid}/friend_requests_received/${senderUid}`).remove();

            // Remove request from sender's sent requests
            await db.ref(`users/${senderUid}/friend_requests_sent/${currentUid}`).remove();

            alert(`Anda sekarang berteman dengan ${senderUsername}!`);
            loadFriendList(); // Refresh friend list
            loadFriendRequests(); // Refresh requests list
        } catch (error) {
            console.error("Error accepting friend request:", error);
            alert("Gagal menerima permintaan pertemanan. Coba lagi.");
        }
    }

    async function declineFriendRequest(senderUid) {
        try {
            // Remove request from current user's received requests
            await db.ref(`users/${currentUid}/friend_requests_received/${senderUid}`).remove();

            // Remove request from sender's sent requests
            await db.ref(`users/${senderUid}/friend_requests_sent/${currentUid}`).remove();

            alert("Permintaan pertemanan ditolak.");
            loadFriendRequests(); // Refresh requests list
        } catch (error) {
            console.error("Error declining friend request:", error);
            alert("Gagal menolak permintaan pertemanan. Coba lagi.");
        }
    }


    // --- Load Friend List ---
    function loadFriendList() {
        if (!currentUid) return;

        friendList.innerHTML = '';
        db.ref(`users/${currentUid}/friends`).on('value', (snapshot) => {
            friendList.innerHTML = '';
            snapshot.forEach((friendNode) => {
                const friendData = friendNode.val();
                const friendItem = document.createElement('div');
                friendItem.classList.add('friend-item');
                friendItem.dataset.friendUid = friendData.uid;

                const avatar = document.createElement('div');
                avatar.classList.add('friend-avatar');
                avatar.textContent = friendData.username.charAt(0).toUpperCase();

                const name = document.createElement('div');
                name.classList.add('friend-name');
                name.textContent = friendData.username;

                friendItem.appendChild(avatar);
                friendItem.appendChild(name);

                friendItem.addEventListener('click', () => {
                    loadPrivateChat(friendData.uid, friendData.username);
                });
                friendList.appendChild(friendItem);
            });
        });
    }

    // --- Logout & Options ---
    optionsButton.addEventListener('click', (event) => {
      logoutMenu.style.display = logoutMenu.style.display === 'flex' ? 'none' : 'flex';
      event.stopPropagation();
    });

    document.addEventListener('click', (event) => {
      if (!logoutMenu.contains(event.target) && event.target !== optionsButton) {
        logoutMenu.style.display = 'none';
      }
    });

    logoutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        alert("Anda telah logout.");
      } catch (error) {
        console.error("Error logging out:", error);
        alert("Gagal logout. Silakan coba lagi.");
      }
    });

    // --- Send Message Logic ---
    sendBtn.onclick = async () => { // Changed to async to await participant setting
      const message = input.value.trim();
      if (!message || !currentUsername || !currentUid) return;

      const msgData = {
        user: currentUsername,
        userUid: currentUid,
        message,
        timestamp: Date.now()
      };
      if (replyTo) msgData.reply = replyTo;

      if (currentChatMode === 'public') {
        db.ref("chats").push(msgData);
      } else if (currentChatMode === 'private' && currentPrivateChatFriendUid) {
        const privateChatId = getPrivateChatId(currentUid, currentPrivateChatFriendUid);
        const privateChatRef = db.ref(`private_chats/${privateChatId}`);

        // IMPORTANT: Set participants FIRST to satisfy Firebase Rules
        // Use update instead of set to avoid overwriting existing data if any
        await privateChatRef.child('participants').update({
            [currentUid]: true,
            [currentPrivateChatFriendUid]: true
        });

        // Then push the message
        db.ref(`private_chats/${privateChatId}/messages`).push(msgData);
      }
      input.value = "";
      cancelReply();
    };

    // --- Image Upload Logic ---
    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file || !currentUsername || !currentUid) return;

      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result.split(',')[1];
        fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
          method: 'POST',
          body: new URLSearchParams({ image: base64 })
        })
        .then(res => res.json())
        .then(async result => { // Changed to async here too
          const msgData = {
            user: currentUsername,
            userUid: currentUid,
            imageURL: result.data.url,
            timestamp: Date.now()
          };
          if (replyTo) msgData.reply = replyTo;

          if (currentChatMode === 'public') {
            db.ref("chats").push(msgData);
          } else if (currentChatMode === 'private' && currentPrivateChatFriendUid) {
            const privateChatId = getPrivateChatId(currentUid, currentPrivateChatFriendUid);
            const privateChatRef = db.ref(`private_chats/${privateChatId}`);

            // IMPORTANT: Set participants FIRST to satisfy Firebase Rules
            await privateChatRef.child('participants').update({
                [currentUid]: true,
                [currentPrivateChatFriendUid]: true
            });

            db.ref(`private_chats/${privateChatId}/messages`).push(msgData);
          }
          cancelReply();
        })
        .catch(err => {
          alert("Gagal upload gambar");
          console.error("Image upload error:", err);
        });
      };
      reader.readAsDataURL(file);
    };

    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendBtn.click();
    });

    // --- Initialization & Event Listeners ---
    let initialViewportHeight = window.innerHeight;
    let isKeyboardOpen = false;

    function onViewportResize() {
        const currentViewportHeight = window.innerHeight;
        const diff = initialViewportHeight - currentViewportHeight;

        if (diff > (initialViewportHeight * 0.2)) {
            if (!isKeyboardOpen) {
                console.log("Keyboard dibuka");
                isKeyboardOpen = true;
                scrollToBottom();
            }
        } else if (diff < (initialViewportHeight * 0.2) && isKeyboardOpen) {
            console.log("Keyboard ditutup");
            isKeyboardOpen = false;
            scrollToBottom();
        }
    }
    window.addEventListener('resize', onViewportResize);

    backToPublicChatButton.addEventListener('click', loadPublicChat);

    // Auth State Change Listener
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUid = user.uid;
        const userProfileRef = db.ref('users/' + currentUid);
        userProfileRef.once('value').then(snapshot => {
          if (snapshot.exists()) {
            currentUsername = snapshot.val().username;
            loginPage.style.display = "none";
            chatWrapper.style.display = "flex";

            adjustChatWrapperPadding();
            window.addEventListener('resize', adjustChatWrapperPadding);

            loadPublicChat();
            loadFriendList(); // Ensure friend list is loaded/updated
            loadFriendRequests(); // Load friend requests when user logs in
          } else {
            console.error("User profile not found in database. Logging out.");
            auth.signOut();
          }
        }).catch(error => {
          console.error("Error fetching user profile:", error);
          auth.signOut();
        });
      } else {
        currentUsername = null;
        currentUid = null;
        loginPage.style.display = "flex";
        chatWrapper.style.display = "none";
        if (chatListenerRef) chatListenerRef.off();
        window.removeEventListener('resize', adjustChatWrapperPadding);
        closeSidebar();
      }
    });

    // Initial padding adjustment on page load
    window.addEventListener('load', () => {
        if (auth.currentUser) {
            adjustChatWrapperPadding();
        }
    });

  </script>

</body>
</html>
